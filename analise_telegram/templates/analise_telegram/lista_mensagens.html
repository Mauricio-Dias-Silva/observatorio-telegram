{% extends 'analise_telegram/base.html' %}

{% block title %}Mensagens Coletadas - Observatório Telegram{% endblock %}

{% block content %}
    <h1 class="mb-4">Mensagens Coletadas</h1>

    <form method="get" class="mb-4">
        <div class="row g-3 align-items-end">
            <div class="col-md-3">
                <label for="canal_id" class="form-label">Canal:</label>
                <select name="canal_id" id="canal_id" class="form-select">
                    <option value="">Todos os Canais</option>
                    {% for c in todos_canais %}
                        <option value="{{ c.id }}" {% if c.id|stringformat:"s" == request.GET.canal_id %}selected{% endif %}>{{ c.nome }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label for="eh_risco" class="form-label">Conteúdo de Risco:</label>
                <select name="eh_risco" id="eh_risco" class="form-select">
                    <option value="">Todos</option>
                    <option value="True" {% if request.GET.eh_risco == "True" %}selected{% endif %}>Sim</option>
                    <option value="False" {% if request.GET.eh_risco == "False" %}selected{% endif %}>Não</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="sentimento" class="form-label">Sentimento:</label>
                <select name="sentimento" id="sentimento" class="form-select">
                    <option value="">Todos</option>
                    <option value="positivo" {% if request.GET.sentimento == "positivo" %}selected{% endif %}>Positivo</option>
                    <option value="neutro" {% if request.GET.sentimento == "neutro" %}selected{% endif %}>Neutro</option>
                    <option value="negativo" {% if request.GET.sentimento == "negativo" %}selected{% endif %}>Negativo</option>
                </select>
            </div>
            <div class="col-md-3">
                <button type="submit" class="btn btn-primary">Aplicar Filtros</button>
                <a href="{% url 'lista_mensagens' %}" class="btn btn-secondary ms-2">Limpar Filtros</a>
            </div>
        </div>
    </form>

    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>Canal</th>
                    <th>Data</th>
                    <th>Conteúdo da Mensagem</th>
                    <th>Risco</th>
                    <th>Sentimento</th>
                </tr>
            </thead>
            <tbody>
                {% for mensagem in mensagens %}
                    <tr>
                        <td>{{ mensagem.canal.nome }}</td>
                        <td>{{ mensagem.data_publicacao|date:"d/m/Y H:i" }}</td>
                        <td>
                            <p>{{ mensagem.texto|truncatechars:300 }}</p>
                            {% if mensagem.tipo_midia %}
                                <span class="badge bg-secondary">{{ mensagem.tipo_midia|capfirst }}</span>
                            {% endif %}
                            {% if mensagem.palavras_chave_encontradas %}
                                {% for palavra in mensagem.palavras_chave_encontradas %}
                                    <span class="badge bg-info text-dark">{{ palavra }}</span>
                                {% endfor %}
                            {% endif %}
                        </td>
                        <td>
                            {% if mensagem.eh_risco %}
                                <span class="badge bg-danger">Sim</span>
                            {% else %}
                                <span class="badge bg-success">Não</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if mensagem.sentimento == 'positivo' %}
                                <span class="badge bg-success">{{ mensagem.sentimento|capfirst }}</span>
                            {% elif mensagem.sentimento == 'negativo' %}
                                <span class="badge bg-danger">{{ mensagem.sentimento|capfirst }}</span>
                            {% elif mensagem.sentimento == 'neutro' %}
                                <span class="badge bg-secondary">{{ mensagem.sentimento|capfirst }}</span>
                            {% else %}
                                <span class="badge bg-light text-muted">N/A</span>
                            {% endif %}
                        </td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="5">Nenhuma mensagem encontrada com os filtros aplicados.</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <nav aria-label="Paginação">
        <ul class="pagination justify-content-center">
            {% if mensagens.has_previous %}
                <li class="page-item"><a class="page-link" href="?page=1{% if request.GET.canal_id %}&canal_id={{ request.GET.canal_id }}{% endif %}{% if request.GET.eh_risco %}&eh_risco={{ request.GET.eh_risco }}{% endif %}{% if request.GET.sentimento %}&sentimento={{ request.GET.sentimento }}{% endif %}">&laquo; primeira</a></li>
                <li class="page-item"><a class="page-link" href="?page={{ mensagens.previous_page_number }}{% if request.GET.canal_id %}&canal_id={{ request.GET.canal_id }}{% endif %}{% if request.GET.eh_risco %}&eh_risco={{ request.GET.eh_risco }}{% endif %}{% if request.GET.sentimento %}&sentimento={{ request.GET.sentimento }}{% endif %}">anterior</a></li>
            {% endif %}

            <li class="page-item disabled"><span class="page-link">Página {{ mensagens.number }} de {{ mensagens.paginator.num_pages }}.</span></li>

            {% if mensagens.has_next %}
                <li class="page-item"><a class="page-link" href="?page={{ mensagens.next_page_number }}{% if request.GET.canal_id %}&canal_id={{ request.GET.canal_id }}{% endif %}{% if request.GET.eh_risco %}&eh_risco={{ request.GET.eh_risco }}{% endif %}{% if request.GET.sentimento %}&sentimento={{ request.GET.sentimento }}{% endif %}">próxima</a></li>
                <li class="page-item"><a class="page-link" href="?page={{ mensagens.paginator.num_pages }}{% if request.GET.canal_id %}&canal_id={{ request.GET.canal_id }}{% endif %}{% if request.GET.eh_risco %}&eh_risco={{ request.GET.eh_risco }}{% endif %}{% if request.GET.sentimento %}&sentimento={{ request.GET.sentimento }}{% endif %}">&raquo; última</a></li>
            {% endif %}
        </ul>
    </nav>
{% endblock %}